<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chatty | Lead Intelligence Dashboard</title>
    <meta name="theme-color" content="#0b0e14" />
    <link rel="manifest" href="pwa/manifest.json" />
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary: #00f2fe;
        --secondary: #4facfe;
        --bg: #0b0e14;
        --card-bg: rgba(255, 255, 255, 0.03);
        --border: rgba(255, 255, 255, 0.1);
        --text: #e0e0e0;
        --text-muted: #a0a0a0;
        --success: #00ff88;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Outfit", sans-serif;
      }

      body {
        background-color: var(--bg);
        color: var(--text);
        overflow-x: hidden;
        min-height: 100vh;
      }

      .background-blob {
        position: fixed;
        width: 500px;
        height: 500px;
        background: radial-gradient(
          circle,
          rgba(0, 242, 254, 0.1) 0%,
          transparent 70%
        );
        z-index: -1;
        filter: blur(50px);
        animation: move 20s infinite alternate;
      }

      @keyframes move {
        from {
          transform: translate(-10%, -10%);
        }
        to {
          transform: translate(20%, 20%);
        }
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 40px 20px;
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 60px;
        animation: fadeInDown 0.8s ease-out;
      }

      @keyframes fadeInDown {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .logo {
        font-size: 2rem;
        font-weight: 800;
        background: linear-gradient(to right, var(--primary), var(--secondary));
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        letter-spacing: -1px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
      }

      .stat-card {
        background: var(--card-bg);
        border: 1px solid var(--border);
        padding: 30px;
        border-radius: 24px;
        backdrop-filter: blur(10px);
        transition: transform 0.3s ease;
      }

      .stat-card:hover {
        transform: translateY(-5px);
        border-color: var(--primary);
      }

      .stat-label {
        font-size: 0.9rem;
        color: var(--text-muted);
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        color: #fff;
      }

      .lead-section {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 32px;
        padding: 40px;
        backdrop-filter: blur(10px);
        animation: fadeInUp 0.8s ease-out;
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
      }

      h2 {
        font-size: 1.5rem;
        font-weight: 600;
      }

      .lead-table {
        width: 100%;
        border-collapse: collapse;
      }

      .lead-table th {
        text-align: left;
        padding: 15px;
        color: var(--text-muted);
        font-weight: 400;
        border-bottom: 1px solid var(--border);
      }

      .lead-table td {
        padding: 20px 15px;
        border-bottom: 1px solid var(--border);
      }

      .lead-row {
        transition: background 0.3s ease;
        cursor: pointer;
      }

      .lead-row:hover {
        background: rgba(255, 255, 255, 0.02);
      }

      .lead-name {
        font-weight: 600;
        color: #fff;
      }

      .lead-email {
        color: var(--text-muted);
        font-size: 0.9rem;
      }

      .badge {
        padding: 6px 14px;
        border-radius: 100px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
      }

      .badge-new {
        background: rgba(0, 242, 254, 0.1);
        color: var(--primary);
        border: 1px solid rgba(0, 242, 254, 0.2);
      }

      .score-bar {
        width: 100px;
        height: 6px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        overflow: hidden;
      }

      .score-fill {
        height: 100%;
        background: linear-gradient(to right, var(--primary), var(--secondary));
      }

      .btn {
        background: linear-gradient(to right, var(--primary), var(--secondary));
        border: none;
        padding: 12px 24px;
        border-radius: 14px;
        color: #000;
        font-weight: 600;
        cursor: pointer;
        transition: opacity 0.3s ease;
      }

      .btn:hover {
        opacity: 0.9;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: var(--text-muted);
      }

      .workflow-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-top: 24px;
      }

      .workflow-card {
        background: rgba(12, 16, 24, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 22px;
        padding: 22px;
        min-height: 200px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .workflow-title {
        font-size: 1.05rem;
        font-weight: 600;
      }

      .workflow-meta {
        font-size: 0.8rem;
        color: var(--text-muted);
        display: flex;
        justify-content: space-between;
        gap: 8px;
      }

      .step-list {
        list-style: none;
        display: grid;
        gap: 10px;
      }

      .step-item {
        display: flex;
        justify-content: space-between;
        font-size: 0.85rem;
        color: var(--text-muted);
      }

      .step-status {
        text-transform: uppercase;
        font-weight: 600;
        font-size: 0.7rem;
        padding: 2px 8px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.05);
      }

      .step-status.complete {
        color: var(--success);
        border: 1px solid rgba(0, 255, 136, 0.2);
      }

      .step-status.active {
        color: var(--primary);
        border: 1px solid rgba(0, 242, 254, 0.2);
      }

      .step-status.queued {
        color: #ffc857;
        border: 1px solid rgba(255, 200, 87, 0.2);
      }

      .command-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 20px;
        margin-top: 24px;
      }

      .panel {
        background: rgba(8, 12, 18, 0.88);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 22px;
        padding: 22px;
      }

      .panel h3 {
        font-size: 1rem;
        margin-bottom: 12px;
      }

      .agent-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.06);
        font-size: 0.8rem;
        margin: 4px 6px 0 0;
      }

      .agent-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--success);
      }

      .prompt-textarea {
        width: 100%;
        min-height: 120px;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        color: var(--text);
        padding: 14px;
        resize: vertical;
      }

      .prompt-row {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 12px;
      }

      .prompt-log {
        display: grid;
        gap: 10px;
        max-height: 240px;
        overflow-y: auto;
      }

      .log-entry {
        padding: 10px 12px;
        background: rgba(255, 255, 255, 0.04);
        border-radius: 14px;
        font-size: 0.8rem;
        color: var(--text-muted);
      }

      .log-entry strong {
        color: #fff;
        font-weight: 600;
      }

      .task-list {
        display: grid;
        gap: 10px;
        max-height: 240px;
        overflow-y: auto;
      }

      .task-item {
        padding: 10px 12px;
        background: rgba(255, 255, 255, 0.04);
        border-radius: 14px;
        font-size: 0.8rem;
        color: var(--text-muted);
      }

      .task-item strong {
        color: #fff;
        font-weight: 600;
      }

      .collab-feed {
        display: grid;
        gap: 10px;
        max-height: 260px;
        overflow-y: auto;
      }

      .message-input {
        width: 100%;
        min-height: 90px;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        color: var(--text);
        padding: 14px;
        resize: vertical;
      }

      .pipeline-card {
        padding: 12px 14px;
        background: rgba(255, 255, 255, 0.04);
        border-radius: 14px;
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-bottom: 10px;
      }

      .pipeline-card strong {
        color: #fff;
        font-weight: 600;
      }

      .campaign-list {
        display: grid;
        gap: 10px;
        max-height: 220px;
        overflow-y: auto;
      }

      .n8n-list {
        display: grid;
        gap: 10px;
        max-height: 220px;
        overflow-y: auto;
      }

      .transparency-list {
        display: grid;
        gap: 10px;
        max-height: 260px;
        overflow-y: auto;
      }

      .growth-list {
        display: grid;
        gap: 10px;
        max-height: 240px;
        overflow-y: auto;
      }

      .generator-output {
        min-height: 140px;
        background: rgba(255, 255, 255, 0.04);
        border-radius: 16px;
        padding: 12px;
        font-size: 0.8rem;
        color: var(--text-muted);
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body>
    <div class="background-blob"></div>
    <div class="container">
      <header>
        <div class="logo">CHATTY.AI</div>
        <button class="btn" onclick="fetchLeads()">Refresh Intelligence</button>
      </header>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Total Leads</div>
          <div class="stat-value" id="count-total">...</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">New Opportunities</div>
          <div class="stat-value" id="count-new">...</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Avg Lead Score</div>
          <div class="stat-value" id="avg-score">...</div>
        </div>
      </div>

      <div class="lead-section">
        <div class="section-header">
          <h2>Generated Lead Intelligence</h2>
          <div
            id="status-msg"
            style="font-size: 0.8rem; color: var(--success); opacity: 0"
          >
            Updated just now
          </div>
        </div>

        <table class="lead-table">
          <thead>
            <tr>
              <th>Lead</th>
              <th>Source</th>
              <th>Score</th>
              <th>Status</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="lead-body">
            <tr class="loading">
              <td colspan="6">Decrypting lead intelligence network...</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="lead-section" style="margin-top: 32px;">
        <div class="section-header">
          <h2>NarcoGuard Transparent Workflows</h2>
          <button class="btn" onclick="refreshWorkflows()">Refresh Workflows</button>
        </div>
        <div id="workflow-grid" class="workflow-grid">
          <div class="loading">Syncing workflow telemetry...</div>
        </div>
      </div>

      <div class="lead-section" style="margin-top: 32px;">
        <div class="section-header">
          <h2>Command Center: Prompt Chatty + Agents</h2>
          <div id="prompt-status" style="font-size: 0.8rem; color: var(--success); opacity: 0;">
            Prompt dispatched
          </div>
        </div>
        <div class="command-grid">
          <div class="panel">
            <h3>Broadcast Prompt</h3>
            <textarea id="prompt-input" aria-label="Broadcast prompt to agents" class="prompt-textarea" placeholder="Ask Chatty to run a Narcoguard workflow, request a report, or instruct all agents..."></textarea>
            <div class="prompt-row">
              <button class="btn" onclick="sendPrompt('all')">Send to All Agents</button>
              <button class="btn" style="background: transparent; color: var(--text); border: 1px solid var(--border);" onclick="sendPrompt(selectedAgent)">Send to Selected</button>
            </div>
          </div>
          <div class="panel">
            <h3>Active Agents</h3>
            <div id="agent-list">Loading agents...</div>
          </div>
          <div class="panel">
            <h3>Recent Prompts</h3>
            <div id="prompt-log" class="prompt-log">
              <div class="log-entry">Awaiting prompts...</div>
            </div>
          </div>
        </div>
      </div>

      <div class="lead-section" style="margin-top: 32px;">
        <div class="section-header">
          <h2>Autonomy Control + Collaboration</h2>
          <button class="btn" onclick="refreshAutonomy()">Sync Autonomy</button>
        </div>
        <div class="command-grid">
          <div class="panel">
            <h3>Queue New Task</h3>
            <textarea id="task-input" aria-label="New task description" class="message-input" placeholder="Describe the task you want agents to execute..."></textarea>
            <div class="prompt-row">
              <input id="task-owner" aria-label="Task owner" style="flex: 1; min-width: 140px;" class="prompt-textarea" placeholder="Owner (optional)" />
              <select id="task-priority" style="flex: 1; min-width: 140px;" class="prompt-textarea">
                <option value="normal">Normal priority</option>
                <option value="high">High priority</option>
                <option value="urgent">Urgent priority</option>
              </select>
            </div>
            <div class="prompt-row">
              <button class="btn" onclick="queueTask()">Queue Task</button>
            </div>
          </div>
          <div class="panel">
            <h3>Autonomy Task Queue</h3>
            <div id="task-list" class="task-list">
              <div class="task-item">No tasks yet.</div>
            </div>
          </div>
          <div class="panel">
            <h3>Collaboration Feed</h3>
            <div id="collab-feed" class="collab-feed">
              <div class="log-entry">No collaboration events yet.</div>
            </div>
          </div>
        </div>
        <div class="command-grid" style="margin-top: 18px;">
          <div class="panel">
            <h3>Operator Messages</h3>
            <textarea id="operator-message" aria-label="Operator message" class="message-input" placeholder="Leave a note for the system or request an update..."></textarea>
            <div class="prompt-row">
              <button class="btn" onclick="sendOperatorMessage()">Send Message</button>
            </div>
          </div>
          <div class="panel">
            <h3>Recent Operator Notes</h3>
            <div id="operator-log" class="prompt-log">
              <div class="log-entry">Awaiting messages...</div>
            </div>
          </div>
        </div>

        <div class="command-grid" style="margin-top: 18px;">
          <div class="panel">
            <h3>Autonomy Status</h3>
            <div id="autonomy-status" class="log-entry">Checking autonomy...</div>
            <div class="prompt-row">
              <button class="btn" onclick="startAutonomy()">Start Autonomy</button>
              <button class="btn" style="background: transparent; color: var(--text); border: 1px solid var(--border);" onclick="stopAutonomy()">Stop Autonomy</button>
            </div>
            <div class="prompt-row">
              <input id="autonomy-budget" aria-label="Daily autonomy budget in USD" class="prompt-textarea" placeholder="Daily budget (USD)" />
              <input id="autonomy-channel" aria-label="Primary autonomy channel" class="prompt-textarea" placeholder="Primary channel" />
            </div>
            <div class="prompt-row">
              <button class="btn" onclick="saveAutonomySettings()">Save Settings</button>
            </div>
          </div>
          <div class="panel">
            <h3>Pipelines</h3>
            <div id="pipeline-list">
              <div class="pipeline-card">Loading pipelines...</div>
            </div>
            <div class="prompt-row">
              <button class="btn" onclick="refreshPipelines()">Advance Pipelines</button>
            </div>
          </div>
          <div class="panel">
            <h3>Campaign Planner</h3>
            <input id="campaign-name" aria-label="Campaign name" class="prompt-textarea" placeholder="Campaign name" />
            <input id="campaign-channel" aria-label="Campaign channel" class="prompt-textarea" placeholder="Channel (email, social, partnerships)" />
            <input id="campaign-goal" aria-label="Campaign goal" class="prompt-textarea" placeholder="Goal (leads, trials, partnerships)" />
            <div class="prompt-row">
              <button class="btn" onclick="addCampaign()">Plan Campaign</button>
            </div>
            <div id="campaign-list" class="campaign-list">
              <div class="log-entry">No campaigns yet.</div>
            </div>
          </div>
        </div>

        <div class="command-grid" style="margin-top: 18px;">
          <div class="panel">
            <h3>n8n Workflow Builder</h3>
            <input id="n8n-name" aria-label="Workflow name" class="prompt-textarea" placeholder="Workflow name" />
            <input id="n8n-description" aria-label="Workflow description" class="prompt-textarea" placeholder="Workflow description" />
            <input id="n8n-trigger" aria-label="Workflow trigger" class="prompt-textarea" placeholder="Trigger (manual, webhook, schedule)" />
            <div class="prompt-row">
              <button class="btn" onclick="createN8nWorkflow()">Create n8n Workflow</button>
            </div>
          </div>
          <div class="panel">
            <h3>Generated n8n Workflows</h3>
            <div id="n8n-list" class="n8n-list">
              <div class="log-entry">No workflows yet.</div>
            </div>
          </div>
        </div>

        <div class="command-grid" style="margin-top: 18px;">
          <div class="panel">
            <h3>Transparency Report</h3>
            <div id="transparency-list" class="transparency-list">
              <div class="log-entry">No completed items yet.</div>
            </div>
          </div>
        </div>

        <div class="command-grid" style="margin-top: 18px;">
          <div class="panel">
            <h3>Trend-Driven Content Briefs</h3>
            <div id="brief-list" class="growth-list">
              <div class="log-entry">No briefs yet.</div>
            </div>
            <div class="prompt-row">
              <button class="btn" onclick="refreshContentBriefs()">Refresh Briefs</button>
            </div>
          </div>
          <div class="panel">
            <h3>Grant Tracker</h3>
            <input id="grant-name" aria-label="Grant name" class="prompt-textarea" placeholder="Grant name" />
            <input id="grant-deadline" aria-label="Grant deadline" class="prompt-textarea" placeholder="Deadline (YYYY-MM-DD)" />
            <div class="prompt-row">
              <button class="btn" onclick="addGrant()">Add Grant</button>
            </div>
            <div id="grant-list" class="growth-list">
              <div class="log-entry">No grants yet.</div>
            </div>
          </div>
          <div class="panel">
            <h3>Pricing Experiments</h3>
            <input id="experiment-name" aria-label="Experiment name" class="prompt-textarea" placeholder="Experiment name" />
            <input id="experiment-metric" aria-label="Experiment metric" class="prompt-textarea" placeholder="Metric (conversion, CAC)" />
            <div class="prompt-row">
              <button class="btn" onclick="addPricingExperiment()">Add Experiment</button>
            </div>
            <div id="experiment-list" class="growth-list">
              <div class="log-entry">No experiments yet.</div>
            </div>
          </div>
        </div>

        <div class="command-grid" style="margin-top: 18px;">
          <div class="panel">
            <h3>Generators</h3>
            <input id="generator-title" aria-label="Generator title or topic" class="prompt-textarea" placeholder="Title / Topic" />
            <div class="prompt-row">
              <button class="btn" onclick="generateProposal()">Proposal Draft</button>
              <button class="btn" onclick="generatePressPitch()">Press Pitch</button>
              <button class="btn" onclick="generateVideoScript()">Video Script</button>
            </div>
            <div id="generator-output" class="generator-output">Generator output will appear here.</div>
          </div>
          <div class="panel">
            <h3>KPI Anomalies</h3>
            <div id="anomaly-list" class="growth-list">
              <div class="log-entry">No anomalies detected.</div>
            </div>
            <div class="prompt-row">
              <button class="btn" onclick="refreshAnomalies()">Refresh</button>
            </div>
          </div>
          <div class="panel">
            <h3>Weekly Brief</h3>
            <div id="weekly-brief" class="generator-output">No brief yet.</div>
            <div class="prompt-row">
              <button class="btn" onclick="refreshWeeklyBrief()">Refresh Brief</button>
            </div>
          </div>
        </div>
      </div>

      <div id="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modal-title" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: var(--bg); border: 1px solid var(--primary); padding: 40px; border-radius: 32px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto; position: relative;">
            <button onclick="closeModal()" aria-label="Close modal" style="position: absolute; top: 20px; right: 20px; background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer;">&times;</button>
            <h2 id="modal-title" style="margin-bottom: 20px; background: linear-gradient(to right, var(--primary), var(--secondary)); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent;">AI Conversion Strategy</h2>
            <div id="modal-content" style="white-space: pre-wrap; line-height: 1.6; color: var(--text);"></div>
            <div style="margin-top: 30px; display: flex; justify-content: flex-end;">
              <button id="copy-strategy-btn" class="btn" style="background: transparent; color: var(--text-muted); border: 1px solid var(--border);" onclick="copyStrategy()">Copy Strategy</button>
            </div>
        </div>
      </div>
    </div>

    <script>
      const apiBase = "http://localhost:8080";
      let selectedAgent = null;

      function escapeHTML(str) {
        if (!str) return '';
        return str.toString()
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

      async function fetchLeads() {
        const btn = document.querySelector('header .btn');
        const originalText = btn.innerText;
        btn.innerText = "Refreshing...";
        btn.disabled = true;

        try {
          const response = await fetch(`${apiBase}/api/leads`);
          const data = await response.json();

          updateDashboard(data);

          const status = document.getElementById("status-msg");
          status.style.opacity = 1;
          setTimeout(() => (status.style.opacity = 0), 3000);
        } catch (error) {
          console.error("Failed to fetch leads:", error);
        } finally {
          btn.innerText = originalText;
          btn.disabled = false;
        }
      }

      async function focusAgent(leadId, btn) {
        const leadName = btn.closest('tr').querySelector('.lead-name').innerText;
        const originalText = btn.innerText;
        btn.innerText = "Targeting...";
          btn.disabled = true;

        try {
          const response = await fetch(`${apiBase}/api/leads/${leadId}/convert`, {
            method: 'POST'
          });
          const data = await response.json();
          
          if (data.status === "success") {
            showModal(leadName, data.strategy);
            fetchLeads(); // Refresh to show "engaging" status
          } else {
            alert("Agent failed to engage: " + (data.detail || "Unknown error"));
          }
        } catch (error) {
          console.error("Focus failed:", error);
          alert("Network error while deploying agent.");
        } finally {
          btn.innerText = originalText;
          btn.disabled = false;
        }
      }

      function showModal(name, strategy) {
        document.getElementById("modal-title").innerText = `AI Conversion Strategy for ${name}`;
        document.getElementById("modal-content").innerText = strategy;
        document.getElementById("modal-overlay").style.display = "flex";
      }

      function closeModal() {
        document.getElementById("modal-overlay").style.display = "none";
      }

      // Close modal on Escape key
      window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeModal();
        }
      });

      // Submit forms on Enter key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA')) {
          // Find the nearest panel and its primary button
          const panel = e.target.closest('.panel');
          if (panel) {
            const btn = panel.querySelector('.btn');
            if (btn && !btn.disabled) {
              e.preventDefault();
              btn.click();
            }
          }
        }
      });

      async function copyStrategy() {
        const strategy = document.getElementById("modal-content").innerText;
        const btn = document.getElementById("copy-strategy-btn");

        try {
          await navigator.clipboard.writeText(strategy);
          const originalText = btn.innerText;
          btn.innerText = "Copied!";
          btn.style.color = "var(--success)";
          btn.style.borderColor = "var(--success)";

          setTimeout(() => {
            btn.innerText = originalText;
            btn.style.color = "var(--text-muted)";
            btn.style.borderColor = "var(--border)";
          }, 2000);
        } catch (err) {
          console.error("Failed to copy strategy:", err);
        }
      }

      function updateDashboard(data) {
        document.getElementById("count-total").innerText = data.total;
        document.getElementById("count-new").innerText = data.new;

        const leads = data.leads;
        const avgScore =
          leads.length > 0
            ? Math.round(
                leads.reduce((sum, l) => sum + (l.lead_score || 0), 0) /
                  leads.length
              )
            : 0;
        document.getElementById("avg-score").innerText = avgScore + "%";

        const body = document.getElementById("lead-body");
        body.innerHTML = "";

        leads.forEach((lead, index) => {
          const row = document.createElement("tr");
          row.className = "lead-row";
          row.style.animation = `fadeInUp 0.5s ease-out ${index * 0.05}s both`;

          const date = new Date(lead.created_at).toLocaleDateString();
          const badgeClass = lead.status === 'new' ? 'badge-new' : 'badge-engaging';
          
          row.innerHTML = `
                    <td>
                        <div class="lead-name">${escapeHTML(lead.name)}</div>
                        <div class="lead-email">${escapeHTML(lead.email)}</div>
                    </td>
                    <td style="font-size: 0.9rem;">${escapeHTML(lead.source)}</td>
                    <td>
                        <div class="score-bar">
                            <div class="score-fill" style="width: ${lead.lead_score}%"></div>
                        </div>
                        <span style="font-size: 0.75rem; margin-top: 4px; display: block;">${lead.lead_score}%</span>
                    </td>
                    <td><span class="badge ${badgeClass}">${escapeHTML(lead.status)}</span></td>
                    <td style="color: var(--text-muted); font-size: 0.8rem;">${date}</td>
                    <td>
                        <button id="btn-${lead.id}" class="btn" style="padding: 8px 16px; font-size: 0.8rem;" onclick="focusAgent(${lead.id}, this)">Focus Agent</button>
                    </td>
                `;
          body.appendChild(row);
        });
      }

      async function fetchWorkflows() {
        try {
          const response = await fetch(`${apiBase}/api/narcoguard/workflows`);
          const data = await response.json();
          renderWorkflows(data.workflows || []);
        } catch (error) {
          console.error("Failed to fetch workflows:", error);
        }
      }

      function renderWorkflows(workflows) {
        const grid = document.getElementById("workflow-grid");
        grid.innerHTML = "";

        if (!workflows.length) {
          grid.innerHTML = '<div class="loading">No workflows registered.</div>';
          return;
        }

        workflows.forEach((workflow) => {
          const card = document.createElement("div");
          card.className = "workflow-card";
          const lastRun = workflow.last_run ? new Date(workflow.last_run).toLocaleString() : "Never";
          const stepItems = workflow.steps
            .map(
              (step) =>
                `<li class="step-item"><span>${escapeHTML(step.name)}</span><span class="step-status ${escapeHTML(step.status)}">${escapeHTML(step.status)}</span></li>`
            )
            .join("");

          card.innerHTML = `
            <div class="workflow-title">${escapeHTML(workflow.name)}</div>
            <div class="workflow-meta">
              <span>${escapeHTML(workflow.owner)}</span>
              <span>Progress: ${workflow.progress}%</span>
            </div>
            <div class="workflow-meta">
              <span>Status: ${escapeHTML(workflow.status)}</span>
              <span>Last run: ${lastRun}</span>
            </div>
            <ul class="step-list">${stepItems}</ul>
          `;
          grid.appendChild(card);
        });
      }

      async function refreshWorkflows() {
        try {
          await fetch(`${apiBase}/api/narcoguard/workflows/refresh`, { method: "POST" });
          fetchWorkflows();
        } catch (error) {
          console.error("Failed to refresh workflows:", error);
        }
      }

      async function fetchAgents() {
        try {
          const response = await fetch(`${apiBase}/api/agents`);
          const data = await response.json();
          renderAgents(data.agents || []);
        } catch (error) {
          console.error("Failed to fetch agents:", error);
        }
      }

      function renderAgents(agents) {
        const list = document.getElementById("agent-list");
        list.innerHTML = "";
        if (!agents.length) {
          list.innerHTML = "No agents available.";
          return;
        }

        agents.forEach((agent) => {
          const chip = document.createElement("button");
          chip.className = "agent-chip";
          chip.type = "button";
          chip.style.cursor = "pointer";
          chip.innerHTML = `<span class="agent-dot"></span>${escapeHTML(agent.name)}`;
          chip.onclick = () => {
            selectedAgent = agent.name;
            document.querySelectorAll(".agent-chip").forEach((el) => {
              el.style.border = "1px solid transparent";
            });
            chip.style.border = "1px solid var(--primary)";
          };
          list.appendChild(chip);
        });
      }

      async function sendPrompt(target) {
        const promptInput = document.getElementById("prompt-input");
        const prompt = promptInput.value.trim();
        if (!prompt) {
          alert("Add a prompt before sending.");
          return;
        }

        const targets = target === "all" ? ["all"] : selectedAgent ? [selectedAgent] : [];
        if (target !== "all" && !targets.length) {
          alert("Select an agent or use Send to All.");
          return;
        }

        try {
          const response = await fetch(`${apiBase}/api/agents/prompt`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              prompt,
              targets
            })
          });
          const data = await response.json();
          updatePromptLog(data.history || []);
          promptInput.value = "";
          const status = document.getElementById("prompt-status");
          status.style.opacity = 1;
          setTimeout(() => (status.style.opacity = 0), 3000);
        } catch (error) {
          console.error("Prompt failed:", error);
          alert("Prompt dispatch failed.");
        }
      }

      function updatePromptLog(entries) {
        const log = document.getElementById("prompt-log");
        if (!entries.length) {
          log.innerHTML = '<div class="log-entry">Awaiting prompts...</div>';
          return;
        }

        log.innerHTML = entries
          .slice(0, 8)
          .map(
            (entry) =>
              `<div class="log-entry"><strong>${escapeHTML(entry.targets.join(", "))}</strong> • ${new Date(entry.timestamp).toLocaleTimeString()}<br>${escapeHTML(entry.prompt)}</div>`
          )
          .join("");
      }

      async function fetchTasks() {
        try {
          const response = await fetch(`${apiBase}/api/tasks`);
          const data = await response.json();
          renderTasks(data.tasks || []);
        } catch (error) {
          console.error("Failed to fetch tasks:", error);
        }
      }

      function renderTasks(tasks) {
        const list = document.getElementById("task-list");
        if (!tasks.length) {
          list.innerHTML = '<div class="task-item">No tasks yet.</div>';
          return;
        }
        list.innerHTML = tasks
          .slice(0, 8)
          .map(
            (task) =>
              `<div class="task-item"><strong>${escapeHTML(task.title)}</strong><br>${escapeHTML(task.owner)} • ${escapeHTML(task.priority)} • ${escapeHTML(task.status)}</div>`
          )
          .join("");
      }

      async function queueTask() {
        const titleInput = document.getElementById("task-input");
        const ownerInput = document.getElementById("task-owner");
        const priorityInput = document.getElementById("task-priority");
        const title = titleInput.value.trim();
        if (!title) {
          alert("Add a task description before queueing.");
          return;
        }
        try {
          await fetch(`${apiBase}/api/tasks`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              title,
              owner: ownerInput.value.trim() || undefined,
              priority: priorityInput.value
            })
          });
          titleInput.value = "";
          ownerInput.value = "";
          fetchTasks();
          fetchCollabFeed();
        } catch (error) {
          console.error("Failed to queue task:", error);
          alert("Task queue failed.");
        }
      }

      async function fetchCollabFeed() {
        try {
          const response = await fetch(`${apiBase}/api/agents/collab`);
          const data = await response.json();
          renderCollabFeed(data.events || []);
        } catch (error) {
          console.error("Failed to fetch collaboration feed:", error);
        }
      }

      function renderCollabFeed(events) {
        const feed = document.getElementById("collab-feed");
        if (!events.length) {
          feed.innerHTML = '<div class="log-entry">No collaboration events yet.</div>';
          return;
        }
        feed.innerHTML = events
          .slice(0, 10)
          .map(
            (event) =>
              `<div class="log-entry"><strong>${escapeHTML(event.agent)}</strong> • ${escapeHTML(event.event)}<br>${escapeHTML(event.detail)}</div>`
          )
          .join("");
      }

      async function fetchOperatorMessages() {
        try {
          const response = await fetch(`${apiBase}/api/user/messages`);
          const data = await response.json();
          renderOperatorMessages(data.messages || []);
        } catch (error) {
          console.error("Failed to fetch operator messages:", error);
        }
      }

      function renderOperatorMessages(messages) {
        const log = document.getElementById("operator-log");
        if (!messages.length) {
          log.innerHTML = '<div class="log-entry">Awaiting messages...</div>';
          return;
        }
        log.innerHTML = messages
          .slice(0, 8)
          .map(
            (message) =>
              `<div class="log-entry"><strong>${escapeHTML(message.channel)}</strong> • ${new Date(message.timestamp).toLocaleTimeString()}<br>${escapeHTML(message.message)}</div>`
          )
          .join("");
      }

      async function sendOperatorMessage() {
        const input = document.getElementById("operator-message");
        const message = input.value.trim();
        if (!message) {
          alert("Add a message before sending.");
          return;
        }
        try {
          await fetch(`${apiBase}/api/user/messages`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              message
            })
          });
          input.value = "";
          fetchOperatorMessages();
          fetchCollabFeed();
        } catch (error) {
          console.error("Failed to send operator message:", error);
          alert("Message send failed.");
        }
      }

      async function refreshAll() {
        const statusMsg = document.getElementById("status-msg");
        const originalMsg = statusMsg.innerText;
        statusMsg.innerText = "Syncing...";
        statusMsg.style.opacity = 1;

        try {
          const response = await fetch(`${apiBase}/api/dashboard/all`);
          const data = await response.json();

          if (data.leads) updateDashboard(data.leads);
          if (data.workflows) renderWorkflows(data.workflows.workflows || []);
          if (data.agents) renderAgents(data.agents.agents || []);
          if (data.tasks) renderTasks(data.tasks.tasks || []);
          if (data.collab) renderCollabFeed(data.collab.events || []);
          if (data.messages) renderOperatorMessages(data.messages.messages || []);
          if (data.autonomy) renderAutonomyStatus(data.autonomy.state, data.autonomy.settings);
          if (data.pipelines) renderPipelines(data.pipelines.pipelines || []);
          if (data.campaigns) renderCampaigns(data.campaigns.campaigns || []);
          if (data.n8n) renderN8nWorkflows(data.n8n.workflows || []);
          if (data.transparency) renderTransparency(data.transparency.completed || []);
          if (data.briefs) renderContentBriefs(data.briefs.briefs || []);
          if (data.grants) renderGrants(data.grants.grants || []);
          if (data.experiments) renderPricingExperiments(data.experiments.experiments || []);
          if (data.anomalies) renderAnomalies(data.anomalies.anomalies || []);
          if (data.weekly) document.getElementById("weekly-brief").textContent = data.weekly.summary || "No summary.";

          statusMsg.innerText = `Refreshed at ${new Date().toLocaleTimeString()}`;
          setTimeout(() => (statusMsg.style.opacity = 0), 3000);
        } catch (error) {
          console.error("Failed to refresh dashboard:", error);
          statusMsg.innerText = "Sync failed";
          statusMsg.style.color = "red";
          setTimeout(() => {
            statusMsg.style.opacity = 0;
            statusMsg.style.color = "var(--success)";
            statusMsg.innerText = originalMsg;
          }, 3000);
        }
      }

      function refreshAutonomy() {
        refreshAll();
      }

      async function fetchAutonomyStatus() {
        try {
          const response = await fetch(`${apiBase}/api/autonomy/status`);
          const data = await response.json();
          renderAutonomyStatus(data.state, data.settings);
        } catch (error) {
          console.error("Failed to fetch autonomy status:", error);
        }
      }

      function renderAutonomyStatus(state, settings) {
        const status = document.getElementById("autonomy-status");
        status.innerHTML = `<strong>Status:</strong> ${escapeHTML(state.running ? "running" : "stopped")} • Mode: ${escapeHTML(state.mode)}<br><strong>Last tick:</strong> ${escapeHTML(state.last_tick || "n/a")}`;
        document.getElementById("autonomy-budget").value = settings.daily_budget ?? "";
        document.getElementById("autonomy-channel").value = settings.primary_channel ?? "";
      }

      async function startAutonomy() {
        await fetch(`${apiBase}/api/autonomy/start`, { method: "POST" });
        fetchAutonomyStatus();
        fetchCollabFeed();
      }

      async function stopAutonomy() {
        await fetch(`${apiBase}/api/autonomy/stop`, { method: "POST" });
        fetchAutonomyStatus();
        fetchCollabFeed();
      }

      async function saveAutonomySettings() {
        const dailyBudget = parseFloat(document.getElementById("autonomy-budget").value);
        const primaryChannel = document.getElementById("autonomy-channel").value.trim();
        await fetch(`${apiBase}/api/autonomy/settings`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            daily_budget: Number.isNaN(dailyBudget) ? undefined : dailyBudget,
            primary_channel: primaryChannel || undefined
          })
        });
        fetchAutonomyStatus();
      }

      async function fetchPipelines() {
        try {
          const response = await fetch(`${apiBase}/api/pipelines`);
          const data = await response.json();
          renderPipelines(data.pipelines || []);
        } catch (error) {
          console.error("Failed to fetch pipelines:", error);
        }
      }

      function renderPipelines(pipelinesData) {
        const list = document.getElementById("pipeline-list");
        if (!pipelinesData.length) {
          list.innerHTML = '<div class="pipeline-card">No pipelines available.</div>';
          return;
        }
        list.innerHTML = pipelinesData
          .map((pipeline) => {
            const stages = pipeline.stages.map((stage) => `${escapeHTML(stage.name)}: ${escapeHTML(stage.status)}`).join(" • ");
            return `<div class="pipeline-card"><strong>${escapeHTML(pipeline.name)}</strong><br>${stages}<br>Progress: ${pipeline.progress}%</div>`;
          })
          .join("");
      }

      async function refreshPipelines() {
        await fetch(`${apiBase}/api/pipelines/refresh`, { method: "POST" });
        fetchPipelines();
        fetchCollabFeed();
      }

      async function fetchCampaigns() {
        try {
          const response = await fetch(`${apiBase}/api/campaigns`);
          const data = await response.json();
          renderCampaigns(data.campaigns || []);
        } catch (error) {
          console.error("Failed to fetch campaigns:", error);
        }
      }

      function renderCampaigns(items) {
        const list = document.getElementById("campaign-list");
        if (!items.length) {
          list.innerHTML = '<div class="log-entry">No campaigns yet.</div>';
          return;
        }
        list.innerHTML = items
          .slice(0, 6)
          .map(
            (item) =>
              `<div class="log-entry"><strong>${escapeHTML(item.name)}</strong> • ${escapeHTML(item.channel)}<br>${escapeHTML(item.goal)} • ${escapeHTML(item.status)}</div>`
          )
          .join("");
      }

      async function addCampaign() {
        const name = document.getElementById("campaign-name").value.trim();
        const channel = document.getElementById("campaign-channel").value.trim();
        const goal = document.getElementById("campaign-goal").value.trim();
        if (!name || !channel || !goal) {
          alert("Fill in campaign name, channel, and goal.");
          return;
        }
        await fetch(`${apiBase}/api/campaigns`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, channel, goal })
        });
        document.getElementById("campaign-name").value = "";
        document.getElementById("campaign-channel").value = "";
        document.getElementById("campaign-goal").value = "";
        fetchCampaigns();
        fetchCollabFeed();
      }

      async function fetchN8nWorkflows() {
        try {
          const response = await fetch(`${apiBase}/api/n8n/workflows`);
          const data = await response.json();
          renderN8nWorkflows(data.workflows || []);
        } catch (error) {
          console.error("Failed to fetch n8n workflows:", error);
        }
      }

      function renderN8nWorkflows(items) {
        const list = document.getElementById("n8n-list");
        if (!items.length) {
          list.innerHTML = '<div class="log-entry">No workflows yet.</div>';
          return;
        }
        list.innerHTML = items
          .slice(0, 6)
          .map(
            (item) =>
              `<div class="log-entry"><strong>${escapeHTML(item.name)}</strong> • ${escapeHTML(item.trigger)}<br>${escapeHTML(item.description || "No description")}<br>${escapeHTML(item.path)}</div>`
          )
          .join("");
      }

      async function createN8nWorkflow() {
        const name = document.getElementById("n8n-name").value.trim();
        const description = document.getElementById("n8n-description").value.trim();
        const trigger = document.getElementById("n8n-trigger").value.trim();
        if (!name) {
          alert("Provide a workflow name.");
          return;
        }
        await fetch(`${apiBase}/api/n8n/workflows`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            name,
            description: description || undefined,
            trigger: trigger || "manual"
          })
        });
        document.getElementById("n8n-name").value = "";
        document.getElementById("n8n-description").value = "";
        document.getElementById("n8n-trigger").value = "";
        fetchN8nWorkflows();
        fetchCollabFeed();
      }

      async function fetchTransparency() {
        try {
          const response = await fetch(`${apiBase}/api/transparency/report`);
          const data = await response.json();
          renderTransparency(data.completed || []);
        } catch (error) {
          console.error("Failed to fetch transparency report:", error);
        }
      }

      async function fetchContentBriefs() {
        try {
          const response = await fetch(`${apiBase}/api/content/briefs`);
          const data = await response.json();
          renderContentBriefs(data.briefs || []);
        } catch (error) {
          console.error("Failed to fetch briefs:", error);
        }
      }

      function renderContentBriefs(items) {
        const list = document.getElementById("brief-list");
        if (!items.length) {
          list.innerHTML = '<div class="log-entry">No briefs yet.</div>';
          return;
        }
        list.innerHTML = items
          .slice(0, 8)
          .map((item) => `<div class="log-entry"><strong>${escapeHTML(item.title)}</strong><br>${escapeHTML(item.source)} • ${escapeHTML(item.status)}</div>`)
          .join("");
      }

      async function refreshContentBriefs() {
        await fetch(`${apiBase}/api/content/briefs/refresh`, { method: "POST" });
        fetchContentBriefs();
      }

      async function fetchGrants() {
        try {
          const response = await fetch(`${apiBase}/api/grants`);
          const data = await response.json();
          renderGrants(data.grants || []);
        } catch (error) {
          console.error("Failed to fetch grants:", error);
        }
      }

      function renderGrants(items) {
        const list = document.getElementById("grant-list");
        if (!items.length) {
          list.innerHTML = '<div class="log-entry">No grants yet.</div>';
          return;
        }
        list.innerHTML = items
          .slice(0, 6)
          .map((item) => `<div class="log-entry"><strong>${escapeHTML(item.name)}</strong><br>${escapeHTML(item.deadline)}</div>`)
          .join("");
      }

      async function addGrant() {
        const name = document.getElementById("grant-name").value.trim();
        const deadline = document.getElementById("grant-deadline").value.trim();
        if (!name || !deadline) {
          alert("Provide grant name and deadline.");
          return;
        }
        await fetch(`${apiBase}/api/grants`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, deadline })
        });
        document.getElementById("grant-name").value = "";
        document.getElementById("grant-deadline").value = "";
        fetchGrants();
      }

      async function fetchPricingExperiments() {
        try {
          const response = await fetch(`${apiBase}/api/experiments/pricing`);
          const data = await response.json();
          renderPricingExperiments(data.experiments || []);
        } catch (error) {
          console.error("Failed to fetch experiments:", error);
        }
      }

      function renderPricingExperiments(items) {
        const list = document.getElementById("experiment-list");
        if (!items.length) {
          list.innerHTML = '<div class="log-entry">No experiments yet.</div>';
          return;
        }
        list.innerHTML = items
          .slice(0, 6)
          .map((item) => `<div class="log-entry"><strong>${escapeHTML(item.name)}</strong><br>${escapeHTML(item.metric)} • ${escapeHTML(item.status)}</div>`)
          .join("");
      }

      async function addPricingExperiment() {
        const name = document.getElementById("experiment-name").value.trim();
        const metric = document.getElementById("experiment-metric").value.trim();
        if (!name || !metric) {
          alert("Provide experiment name and metric.");
          return;
        }
        await fetch(`${apiBase}/api/experiments/pricing`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, hypothesis: "Improve conversion", metric })
        });
        document.getElementById("experiment-name").value = "";
        document.getElementById("experiment-metric").value = "";
        fetchPricingExperiments();
      }

      async function generateProposal() {
        const title = document.getElementById("generator-title").value.trim() || "Pilot Proposal";
        const response = await fetch(`${apiBase}/api/proposals/draft`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ title })
        });
        const data = await response.json();
        document.getElementById("generator-output").innerText = data.draft || "No draft returned.";
      }

      async function generatePressPitch() {
        const angle = document.getElementById("generator-title").value.trim() || "Automation for harm reduction";
        const response = await fetch(`${apiBase}/api/press/pitch`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ angle })
        });
        const data = await response.json();
        document.getElementById("generator-output").innerText = data.draft || "No pitch returned.";
      }

      async function generateVideoScript() {
        const topic = document.getElementById("generator-title").value.trim() || "NarcoGuard demo";
        const response = await fetch(`${apiBase}/api/video/script`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ topic, length_sec: 90 })
        });
        const data = await response.json();
        document.getElementById("generator-output").innerText = data.draft || "No script returned.";
      }

      async function fetchAnomalies() {
        try {
          const response = await fetch(`${apiBase}/api/kpi/anomalies`);
          const data = await response.json();
          renderAnomalies(data.anomalies || []);
        } catch (error) {
          console.error("Failed to fetch anomalies:", error);
        }
      }

      function renderAnomalies(items) {
        const list = document.getElementById("anomaly-list");
        if (!items.length) {
          list.innerHTML = '<div class="log-entry">No anomalies detected.</div>';
          return;
        }
        list.innerHTML = items
          .slice(0, 6)
          .map((item) => `<div class="log-entry"><strong>${escapeHTML(item.metric)}</strong><br>${escapeHTML(item.value)} vs ${escapeHTML(item.baseline)}</div>`)
          .join("");
      }

      async function fetchWeeklyBrief() {
        try {
          const response = await fetch(`${apiBase}/api/weekly/brief`);
          const data = await response.json();
          // Using textContent for safety, though it was already using innerText
          document.getElementById("weekly-brief").textContent = data.summary || "No summary.";
        } catch (error) {
          console.error("Failed to fetch weekly brief:", error);
        }
      }

      function renderTransparency(items) {
        const list = document.getElementById("transparency-list");
        if (!items.length) {
          list.innerHTML = '<div class="log-entry">No completed items yet.</div>';
          return;
        }
        list.innerHTML = items
          .slice(0, 10)
          .map(
            (item) =>
              `<div class="log-entry"><strong>${escapeHTML(item.category)}</strong> • ${escapeHTML(item.name)}<br>${escapeHTML(item.owner)} • ${new Date(item.timestamp).toLocaleTimeString()}</div>`
          )
          .join("");
      }

      // Add dynamic styles for engaging status
      const style = document.createElement('style');
      style.textContent = `
        .badge-engaging {
            background: rgba(0, 255, 136, 0.1);
            color: var(--success);
            border: 1px solid rgba(0, 255, 136, 0.2);
        }
      `;
      document.head.appendChild(style);

      // Optimized unified polling: 16 sequential calls replaced by 1 batch call
      setInterval(refreshAll, 30000);
      refreshAll();

      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker.register("pwa/sw.js").catch((error) => {
            console.error("Service worker registration failed:", error);
          });
        });
      }
    </script>
  </body>
</html>
